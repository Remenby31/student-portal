# Workshop 5 - Mise en place de l'authentification

## 0. PrÃ©requis

ğŸ‘‰ **Avant de commencer**

Assurez-vous d'avoir :

- **Le projet du Workshop 4** fonctionnel (Ã©diteur d'images avec IA)
- **Votre projet dÃ©ployÃ© sur Vercel** avec les variables d'environnement configurÃ©es
- **AccÃ¨s Ã  votre projet Supabase** utilisÃ© dans le Workshop 4
- **VS Code** avec un assistant de code

---

## 1. Modifier la structure de la base de donnÃ©es

ğŸ‘‰ **Pourquoi ?**

Actuellement, tous les utilisateurs voient tous les projets. Il faut lier chaque projet Ã  un utilisateur pour que chacun ne voie que ses propres crÃ©ations.

### Ajouter la colonne user_id

1. Aller dans **SQL Editor** de Supabase.
2. ExÃ©cuter cette commande :

```sql
-- Ajouter la colonne user_id
ALTER TABLE projects 
ADD COLUMN user_id UUID REFERENCES auth.users(id);

-- CrÃ©er un index pour amÃ©liorer les performances
CREATE INDEX idx_projects_user_id ON projects(user_id);
```

### Activer Row Level Security (RLS)

ğŸ‘‰ **Qu'est-ce que c'est ?**

La RLS (Row Level Security) est un systÃ¨me de sÃ©curitÃ© au niveau de la base de donnÃ©es. Elle permet de dÃ©finir des rÃ¨gles qui contrÃ´lent quelles lignes (rows) chaque utilisateur peut voir, crÃ©er, modifier ou supprimer. 

ConcrÃ¨tement : mÃªme si quelqu'un essaie de pirater votre API, la base de donnÃ©es bloquera automatiquement l'accÃ¨s aux donnÃ©es qui ne lui appartiennent pas.

### Les Ã©tapes

1. Dans **SQL Editor** de Supabase, exÃ©cuter cette commande pour activer la RLS :

```sql
-- Activer Row Level Security sur la table projects
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
```

2. Maintenant, crÃ©er les **policies** (rÃ¨gles de sÃ©curitÃ©). ExÃ©cuter ces commandes **une par une** :

**Policy 1 : Voir ses propres projets**

```sql
-- Un utilisateur peut voir uniquement ses projets
CREATE POLICY "Users can view own projects"
ON projects 
FOR SELECT
USING (auth.uid() = user_id);
```

ğŸ’¡ **Explication** : 
- `FOR SELECT` = cette rÃ¨gle s'applique quand on lit des donnÃ©es
- `USING (auth.uid() = user_id)` = l'utilisateur connectÃ© (`auth.uid()`) doit correspondre au `user_id` du projet
- Si la condition est fausse, la ligne n'est pas retournÃ©e

**Policy 2 : CrÃ©er uniquement avec son propre user_id**

```sql
-- Un utilisateur peut crÃ©er un projet uniquement avec son user_id
CREATE POLICY "Users can insert own projects"
ON projects 
FOR INSERT
WITH CHECK (auth.uid() = user_id);
```

ğŸ’¡ **Explication** :
- `FOR INSERT` = cette rÃ¨gle s'applique quand on crÃ©e une nouvelle ligne
- `WITH CHECK (auth.uid() = user_id)` = vÃ©rifie que le `user_id` insÃ©rÃ© correspond bien Ã  l'utilisateur connectÃ©
- Si quelqu'un essaie d'insÃ©rer un projet avec le `user_id` d'un autre, Ã§a sera bloquÃ©

**Policy 3 : Supprimer uniquement ses propres projets**

```sql
-- Un utilisateur peut supprimer uniquement ses projets
CREATE POLICY "Users can delete own projects"
ON projects 
FOR DELETE
USING (auth.uid() = user_id);
```

ğŸ’¡ **Explication** :
- `FOR DELETE` = cette rÃ¨gle s'applique quand on supprime une ligne
- `USING (auth.uid() = user_id)` = l'utilisateur ne peut supprimer que les projets oÃ¹ il est propriÃ©taire
- Impossible de supprimer les projets des autres utilisateurs

### VÃ©rifier que Ã§a fonctionne

1. Aller dans **Authentication** â†’ **Policies** de Supabase
2. SÃ©lectionner la table `projects`
3. Vous devriez voir vos 3 policies listÃ©es :
   - âœ… Users can view own projects
   - âœ… Users can insert own projects
   - âœ… Users can delete own projects

ğŸ‘‰ RÃ©sultat : la base de donnÃ©es est sÃ©curisÃ©e, chaque utilisateur est isolÃ© ğŸ”’

---

## 2. CrÃ©er l'interface d'authentification complÃ¨te

ğŸ‘‰ **Pourquoi ?**

PlutÃ´t que de crÃ©er chaque fichier un par un, on va demander Ã  l'assistant de code de crÃ©er toute l'infrastructure d'authentification en une seule fois. Les assistants modernes sont capables de comprendre l'architecture complÃ¨te et de crÃ©er tous les fichiers nÃ©cessaires.

### Prompt complet pour l'assistant de code

```
Ajoute l'authentification email/mot de passe Ã  mon projet Next.js avec Supabase.

CONTEXTE :
- Supabase configurÃ©, table projects avec user_id (UUID), RLS activÃ©e avec policies

CE QUE JE VEUX :
- AuthContext avec hook useAuth() qui Ã©coute auth.onAuthStateChange()
- Composant AuthForm avec onglets connexion/inscription + validation
- Header qui affiche email + bouton dÃ©connexion si connectÃ©
- Pages /login et /signup avec AuthForm
- Page /dashboard protÃ©gÃ©e : formulaire upload + galerie "Mes projets" (fetch projects WHERE user_id = auth.uid())
- API generate qui vÃ©rifie l'auth et ajoute user_id lors de l'INSERT
- API delete pour supprimer projets (avec suppression des images des buckets)
- middleware.ts pour protÃ©ger /dashboard et les routes /api
- Landing page / avec CTA vers /signup

Installe @supabase/auth-helpers-nextjs si besoin. CrÃ©e tous les fichiers et explique-moi ce qui a Ã©tÃ© fait.
```

### Concepts clÃ©s

ğŸ’¡ **Context d'authentification** : Un Context React permet de partager l'Ã©tat de l'utilisateur connectÃ© dans toute l'application sans avoir Ã  passer des props partout. Le hook `useAuth()` donnera accÃ¨s Ã  l'utilisateur courant depuis n'importe quel composant.

Exemple d'utilisation :
```tsx
// Dans n'importe quel composant
const { user, loading } = useAuth()

if (loading) return <div>Chargement...</div>
if (!user) return <div>Non connectÃ©</div>
return <div>Bienvenue {user.email}</div>
```

ğŸ’¡ **Middleware** : Un fichier spÃ©cial de Next.js qui s'exÃ©cute **avant** chaque requÃªte. Il vÃ©rifie si l'utilisateur est connectÃ© et bloque l'accÃ¨s aux pages protÃ©gÃ©es (/dashboard, /api/generate, etc.) en redirigeant vers /login si nÃ©cessaire. C'est la premiÃ¨re ligne de dÃ©fense de votre application.

Exemple de flux :
```
Utilisateur essaie d'aller sur /dashboard
    â†“
Middleware s'exÃ©cute
    â†“
Est-il connectÃ© ?
    â”œâ”€ Oui â†’ AccÃ¨s autorisÃ© âœ…
    â””â”€ Non â†’ Redirection vers /login âŒ
```

Exemple de configuration :
```tsx
// middleware.ts
export const config = {
  matcher: ['/dashboard/:path*', '/api/generate/:path*', '/api/delete/:path*']
}

// RÃ©sultat :
// âœ… Accessible sans login : /, /login, /signup
// ğŸ”’ ProtÃ©gÃ© (login requis) : /dashboard, /api/generate, /api/delete
```

### Ce que l'assistant va crÃ©er

L'assistant devrait crÃ©er/modifier :
- âœ… Le Context d'authentification (`context/AuthContext.tsx`)
- âœ… Le composant de formulaire (`components/AuthForm.tsx`)
- âœ… Le Header (`components/Header.tsx`)
- âœ… Les pages login et signup
- âœ… La page dashboard avec galerie
- âœ… L'API delete
- âœ… La modification de l'API generate
- âœ… Le middleware de protection (`middleware.ts`)
- âœ… La modification de la page d'accueil
- âœ… La mise Ã  jour de `app/layout.tsx`

---

## 3. Tester l'authentification complÃ¨te

ğŸ‘‰ **Pourquoi ?**

Maintenant que tout le code est en place, on va tester le parcours complet d'un utilisateur pour vÃ©rifier que tout fonctionne ensemble.

### Ã‰tapes de test

1. **Lancer le serveur** :
```bash
npm run dev
```

2. **Page d'accueil** (`http://localhost:3000/`) :
   - âœ… VÃ©rifier que la landing page s'affiche
   - âœ… VÃ©rifier que le Header affiche "Se connecter"
   - âœ… Cliquer sur "Commencer gratuitement" â†’ doit rediriger vers `/signup`

3. **CrÃ©er un compte** (`/signup`) :
   - âœ… Remplir : email `test@example.com`, mot de passe `password123`, confirmation `password123`
   - âœ… Cliquer sur "S'inscrire"
   - âœ… VÃ©rifier le message de succÃ¨s
   - âœ… Vous devriez Ãªtre redirigÃ© vers `/login`

4. **Se connecter** (`/login`) :
   - âœ… Entrer les mÃªmes identifiants
   - âœ… Cliquer sur "Se connecter"
   - âœ… Vous devriez Ãªtre redirigÃ© vers `/dashboard`
   - âœ… VÃ©rifier que le Header affiche votre email

5. **VÃ©rifier dans Supabase** :
   - âœ… Aller sur Supabase â†’ **Authentication** â†’ **Users**
   - âœ… Vous devriez voir `test@example.com` dans la liste

6. **GÃ©nÃ©rer un projet** (sur `/dashboard`) :
   - âœ… Uploader une image
   - âœ… Ã‰crire un prompt (ex: "add sunglasses")
   - âœ… Cliquer sur "GÃ©nÃ©rer"
   - âœ… Attendre quelques secondes â³
   - âœ… L'image gÃ©nÃ©rÃ©e doit s'afficher

7. **VÃ©rifier le projet dans Supabase** :
   - âœ… Aller dans **Table Editor** â†’ `projects`
   - âœ… La derniÃ¨re ligne doit avoir :
     - `input_image_url`
     - `output_image_url`
     - `prompt`
     - `user_id` (votre UUID)
     - `status: completed`

8. **Recharger le dashboard** :
   - âœ… F5 ou recharger la page
   - âœ… Le projet doit apparaÃ®tre dans "Mes projets"

9. **Supprimer le projet** :
   - âœ… Cliquer sur "Supprimer"
   - âœ… Confirmer
   - âœ… Le projet disparaÃ®t immÃ©diatement
   - âœ… VÃ©rifier dans Supabase que la ligne et les images sont supprimÃ©es

10. **Se dÃ©connecter** :
    - âœ… Cliquer sur "Se dÃ©connecter" dans le Header
    - âœ… Retour sur la page d'accueil
    - âœ… Le Header affiche maintenant "Se connecter"

11. **Tester la protection des routes** :
    - âœ… Essayer d'aller sur `/dashboard` sans Ãªtre connectÃ©
    - âœ… Vous devez Ãªtre redirigÃ© vers `/login`

12. **Tester avec un second utilisateur** :
    - âœ… CrÃ©er un compte : `user2@example.com` / `password123`
    - âœ… Se connecter
    - âœ… GÃ©nÃ©rer un projet
    - âœ… Se dÃ©connecter
    - âœ… Se reconnecter avec `test@example.com`
    - âœ… VÃ©rifier que vous ne voyez PAS les projets de `user2@example.com`

ğŸ‘‰ Si tous les tests passent, l'authentification par email/mot de passe est complÃ¨te ! ğŸ‰

### En cas d'erreur

Si quelque chose ne fonctionne pas :

1. **VÃ©rifier les logs du terminal** pour voir les erreurs
2. **VÃ©rifier la console du navigateur** (F12 â†’ Console)
3. **Demander Ã  l'assistant de corriger** en lui copiant le message d'erreur complet
4. **VÃ©rifier dans Supabase** :
   - Les utilisateurs sont-ils crÃ©Ã©s dans **Authentication** ?
   - Les projets ont-ils un `user_id` dans la table ?
   - Les policies RLS sont-elles actives ?

---

## 4. DÃ©ployer sur Vercel

ğŸ‘‰ **Pourquoi ?**

Maintenant que tout fonctionne en local, on sauvegarde et on dÃ©ploie en production.

### Ã‰tapes

1. **Commit et push** :
   ```bash
   # Dans VS Code, onglet Source Control
   # Message : "Add email/password authentication"
   # Commit â†’ Push
   ```

   ğŸ’¡ **Si erreur de connexion GitHub** :
   - Installer [GitHub Desktop](https://desktop.github.com/download/)
   - Cela vous connectera automatiquement Ã  GitHub
   - RÃ©essayer le commit et push dans VS Code

2. **DÃ©ploiement automatique** :
   - Aller sur [Vercel](https://vercel.com/)
   - Le dÃ©ploiement se lance automatiquement
   - Attendre quelques minutes â³

3. **Tester en production** :
   - Cliquer sur **Visit**
   - Refaire tout le parcours de test
   - CrÃ©er un compte, gÃ©nÃ©rer une image, supprimer, se dÃ©connecter

ğŸ‘‰ Si tout fonctionne en production, l'authentification est complÃ¨te ! ğŸ‰

---

## 5. Configurer Google OAuth (optionnel)

Vous pouvez ajouter Google OAuth pour permettre une connexion en un clic.

### Ã‰tape 1 : CrÃ©er un projet Google Cloud

1. Aller sur [Google Cloud Console](https://console.cloud.google.com/)
2. CrÃ©er un nouveau projet ou sÃ©lectionner un projet existant
3. Aller dans **API & Services** â†’ **Credentials**
4. Cliquer sur **Create Credentials** â†’ **OAuth client ID**
5. Si demandÃ©, configurer l'Ã©cran de consentement OAuth :
   - User Type : **External**
   - App name : nom de votre projet
   - User support email : votre email
   - Developer contact : votre email
   - Sauvegarder et continuer
6. Revenir Ã  **Credentials** â†’ **Create Credentials** â†’ **OAuth client ID**
7. Application type : **Web application**
8. Name : "Supabase Auth"
9. Authorized redirect URIs :
   - Aller dans Supabase â†’ **Authentication** â†’ **Providers** â†’ **Google**
   - Copier le **Callback URL** (format: `https://xxx.supabase.co/auth/v1/callback`)
   - Coller dans Google Cloud Console
10. Cliquer sur **Create**
11. **Copier** le Client ID et Client Secret

### Ã‰tape 2 : Configurer Supabase

1. Dans Supabase â†’ **Authentication** â†’ **Providers**
2. Activer **Google**
3. Coller le **Client ID** et **Client Secret**
4. Sauvegarder

### Ã‰tape 3 : Ajouter le bouton Google

Demander Ã  l'assistant de code :

```
Ajoute un bouton Google OAuth (via supabase) dans components/AuthForm.tsx.

Le bouton doit :
- ÃŠtre placÃ© avant le formulaire email/password
- Utiliser supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: `${window.location.origin}/dashboard` } })
```

### Ã‰tape 4 : Tester Google OAuth

1. Lancer le serveur : `npm run dev`
2. Aller sur `/login` ou `/signup`
3. Cliquer sur **Continuer avec Google**
4. SÃ©lectionner votre compte Google
5. Autoriser l'application
6. Vous devriez Ãªtre redirigÃ© vers `/dashboard` et connectÃ©
7. VÃ©rifier dans Supabase â†’ **Authentication** â†’ **Users** que l'utilisateur est crÃ©Ã©

---

## Ressources

ğŸ“š **Documentation Supabase Auth** : https://supabase.com/docs/guides/auth

ğŸ“š **Row Level Security** : https://supabase.com/docs/guides/auth/row-level-security

ğŸ“š **Supabase Auth avec Next.js** : https://supabase.com/docs/guides/auth/server-side/nextjs

ğŸ“š **Google OAuth Setup** : https://supabase.com/docs/guides/auth/social-login/auth-google

ğŸ“š **Next.js Middleware** : https://nextjs.org/docs/app/building-your-application/routing/middleware

---

ğŸ‰ **Bravo !** Votre SaaS a maintenant une authentification complÃ¨te, un dashboard sÃ©curisÃ©, et chaque utilisateur a ses propres donnÃ©es isolÃ©es !